"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[283],{283:(e,r,t)=>{t.d(r,{A:()=>l,AuthProvider:()=>c});var o=t(5155),a=t(2115),s=t(6104),i=t(6203);let n=(0,a.createContext)({currentUser:null,userProfile:null,userData:null,userRole:"guest",loading:!0,firebaseInitialized:!1}),l=()=>(0,a.useContext)(n),c=e=>{let{children:r}=e,[t,l]=(0,a.useState)(null),[c,d]=(0,a.useState)(null),[u,g]=(0,a.useState)(null),[h,f]=(0,a.useState)("guest"),[m,p]=(0,a.useState)(!0),[b,R]=(0,a.useState)(!!s.j2);return(0,a.useEffect)(()=>{let e=setTimeout(()=>{m&&(console.log("Firebase initialization timed out, continuing without Firebase"),p(!1))},3e3),r=()=>{};if(s.j2){R(!0);try{r=(0,i.hg)(s.j2,async r=>{if(l(r),r)try{let e=null;if(s.v$)try{e=await (0,s.lS)(r.uid)}catch(e){console.error("Error fetching from Realtime Database:",e)}if(!e&&s.db)try{(e=await (0,s.VM)(r.uid))&&s.v$&&console.log("Profile found in Firestore but not in RTDB. Consider migrating data.")}catch(e){console.error("Error fetching from Firestore:",e)}if(d(e),s.v$)try{let e=await (0,s.gL)(r.uid);g(e);let t=await (0,s.uG)(r.uid);f(t),console.log("User role: ".concat(t))}catch(e){console.error("Error fetching user data:",e),f("user")}}catch(e){console.error("Error fetching user profile:",e)}else d(null),g(null),f("guest");p(!1),clearTimeout(e)})}catch(r){console.error("Error setting up auth state listener:",r),p(!1),clearTimeout(e)}}else console.log("Firebase Auth not initialized, continuing without authentication"),p(!1),clearTimeout(e);return()=>{clearTimeout(e),r()}},[]),(0,o.jsx)(n.Provider,{value:{currentUser:t,userProfile:c,userData:u,userRole:h,loading:m,firebaseInitialized:b},children:!m&&r})}},6104:(e,r,t)=>{let o,a,s,i;t.d(r,{BN:()=>y,DY:()=>h,LH:()=>v,Lx:()=>f,M5:()=>E,VM:()=>b,Vz:()=>p,Z_:()=>F,_x:()=>A,cI:()=>w,db:()=>s,fS:()=>R,gL:()=>z,j2:()=>a,lS:()=>D,nW:()=>L,rk:()=>U,uG:()=>I,v$:()=>i,y4:()=>m});var n=t(3915),l=t(6203),c=t(5317),d=t(1115);let u={apiKey:"AIzaSyCFsknHsQQIpjquH2AEd8Jem1z3L52pdWU",authDomain:"shopbazano.firebaseapp.com",projectId:"shopbazano",storageBucket:"shopbazano.firebasestorage.app",messagingSenderId:"170942605445",appId:"1:170942605445:web:1ee04843327a27b2a561ec",measurementId:"G-CS4Y0NNPCL",databaseURL:"https://shopbazano-default-rtdb.asia-southeast1.firebasedatabase.app"};console.log("Firebase config check:"),console.log("- API Key present:",!!u.apiKey),console.log("- Project ID:",u.projectId),console.log("- Database URL:",u.databaseURL);let g=u.apiKey&&"your-api-key"!==u.apiKey&&u.databaseURL&&"your-project-id-default-rtdb.region.firebasedatabase.app"!==u.databaseURL;u.databaseURL?"your-project-id-default-rtdb.region.firebasedatabase.app"===u.databaseURL?console.error("Firebase Realtime Database URL is not configured. Please update NEXT_PUBLIC_FIREBASE_DATABASE_URL in your .env.local file."):u.databaseURL.endsWith("/")&&(console.warn("Firebase Realtime Database URL should not end with a slash. Current value:",u.databaseURL),u.databaseURL=u.databaseURL.replace(/\/$/,""),console.log("Updated Database URL:",u.databaseURL)):console.error("Firebase Realtime Database URL is missing. Please add NEXT_PUBLIC_FIREBASE_DATABASE_URL to your .env.local file.");try{if(g){console.log("Initializing Firebase with valid configuration"),o=0===(0,n.Dk)().length?(0,n.Wp)(u):(0,n.Dk)()[0],a=(0,l.xI)(o),s=(0,c.aU)(o);try{console.log("Initializing Realtime Database with URL:",u.databaseURL),i=(0,d.C3)(o),console.log("Realtime Database initialized successfully")}catch(e){console.error("Error initializing Realtime Database:",e)}}else if(console.warn("Firebase configuration is incomplete or invalid. Some features may not work properly."),u.apiKey&&u.projectId){console.log("Initializing Firebase with minimal configuration");let e={apiKey:u.apiKey,projectId:u.projectId,authDomain:u.authDomain||"".concat(u.projectId,".firebaseapp.com")};u.databaseURL&&(e.databaseURL=u.databaseURL,console.log("Including Database URL in minimal config")),o=0===(0,n.Dk)().length?(0,n.Wp)(e):(0,n.Dk)()[0];try{a=(0,l.xI)(o),console.log("Firebase Auth initialized with minimal config")}catch(e){console.error("Error initializing Firebase Auth:",e)}if(u.databaseURL)try{console.log("Attempting to initialize Realtime Database with minimal config"),i=(0,d.C3)(o),console.log("Realtime Database initialized with minimal config")}catch(e){console.error("Error initializing Realtime Database with minimal config:",e)}}}catch(e){console.error("Error initializing Firebase:",e)}let h=async function(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"user";if(!a)throw Error("Firebase authentication is not initialized");try{let o=await (0,l.eJ)(a,e,r);if(i){let e=(0,d.KR)(i,"users/".concat(o.user.uid));if(await (0,d.hZ)(e,{email:o.user.email,role:t,createdAt:(0,c.O5)(),lastLogin:(0,c.O5)(),displayName:o.user.displayName||"",photoURL:o.user.photoURL||""}),"admin"===t){let e=(0,d.KR)(i,"admins/".concat(o.user.uid));await (0,d.hZ)(e,{email:o.user.email,isAdmin:!0,createdAt:(0,c.O5)()})}}return o.user}catch(e){throw console.error("Registration error:",e),Error(e.message)}},f=async(e,r)=>{if(!a)throw Error("Firebase authentication is not initialized");try{let t=await (0,l.x9)(a,e,r);if(i){let e=(0,d.KR)(i,"users/".concat(t.user.uid));await (0,d.yo)(e,{lastLogin:(0,c.O5)()})}return t.user}catch(e){throw console.error("Login error:",e),Error(e.message)}},m=async()=>{if(!a)throw Error("Firebase authentication is not initialized");try{await (0,l.CI)(a)}catch(e){throw console.error("Logout error:",e),Error(e.message)}},p=async(e,r)=>{if(!s)throw Error("Firebase Firestore is not initialized");try{let t=(0,c.H9)(s,"users",e);await (0,c.BN)(t,{...r,createdAt:(0,c.O5)(),updatedAt:(0,c.O5)()})}catch(e){throw console.error("Create user profile error:",e),Error(e.message)}},b=async e=>{if(!s)throw Error("Firebase Firestore is not initialized");try{let r=(0,c.H9)(s,"users",e),t=await (0,c.x7)(r);if(t.exists())return t.data();return null}catch(e){throw console.error("Get user profile error:",e),Error(e.message)}},R=async(e,r)=>{if(!s)throw Error("Firebase Firestore is not initialized");try{let t=(0,c.rJ)(s,"orders"),o=(0,c.H9)(t);return await (0,c.BN)(o,{userId:e,...r,status:"pending",createdAt:(0,c.O5)(),updatedAt:(0,c.O5)()}),o.id}catch(e){throw console.error("Create order error:",e),Error(e.message)}},w=async(e,r)=>{if(!s)return console.warn("Firebase Firestore is not initialized, skipping order notification"),!1;try{let t=(0,c.rJ)(s,"notifications");return await (0,c.BN)((0,c.H9)(t),{to:"lnduc19502@gmail.com",orderData:e,userEmail:r,createdAt:(0,c.O5)(),sent:!0}),console.log("Order notification for ".concat(e.orderId," has been created")),!0}catch(e){throw console.error("Error creating order notification:",e),Error(e.message)}},y=async(e,r)=>{if(!i)throw console.error("Firebase Realtime Database is not initialized"),Error("Firebase Realtime Database is not initialized");try{console.log("Attempting to save user profile to RTDB for user:",e),console.log("RTDB instance:",i),console.log("Database URL:","https://shopbazano-default-rtdb.asia-southeast1.firebasedatabase.app");let t="users/".concat(e);console.log("User path:",t);let o=(0,d.KR)(i,t);console.log("User ref created:",o);let a={...r,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};console.log("Data to save:",a),await (0,d.hZ)(o,a).then(()=>{console.log("User profile saved successfully to RTDB")}).catch(e=>{throw console.error("Error during set operation:",e),e})}catch(e){throw console.error("Create user profile error (RTDB):",e),console.error("Error details:",e.code,e.message),Error("Failed to save user profile: ".concat(e.message))}},D=async e=>{if(!i)throw console.error("Firebase Realtime Database is not initialized when getting user profile"),Error("Firebase Realtime Database is not initialized");try{console.log("Attempting to get user profile from RTDB for user:",e);let r="users/".concat(e);console.log("User path for get:",r);let t=(0,d.KR)(i,r);console.log("User ref created for get:",t);let o=await (0,d.Jt)(t);if(console.log("Snapshot received:",o.exists()?"Data exists":"No data"),!o.exists())return console.log("No user data found in RTDB"),null;{let e=o.val();return console.log("User data retrieved successfully:",e),e}}catch(e){throw console.error("Get user profile error (RTDB):",e),console.error("Error details:",e.code,e.message),Error("Failed to get user profile: ".concat(e.message))}},E=async(e,r)=>{if(!i)throw console.error("Firebase Realtime Database is not initialized when updating user profile"),Error("Firebase Realtime Database is not initialized");try{console.log("Attempting to update user profile in RTDB for user:",e);let t="users/".concat(e);console.log("User path for update:",t);let o=(0,d.KR)(i,t);console.log("User ref created for update:",o);let a={...r,updatedAt:new Date().toISOString()};console.log("Data to update:",a),await (0,d.yo)(o,a).then(()=>{console.log("User profile updated successfully in RTDB")}).catch(e=>{throw console.error("Error during update operation:",e),e})}catch(e){throw console.error("Update user profile error (RTDB):",e),console.error("Error details:",e.code,e.message),Error("Failed to update user profile: ".concat(e.message))}},U=async(e,r)=>{if(!i)throw console.error("Firebase Realtime Database is not initialized when creating order"),Error("Firebase Realtime Database is not initialized");try{var t,o,s,n;console.log("Attempting to save order to RTDB for user:",e),console.log("RTDB instance:",i),console.log("Database URL:","https://shopbazano-default-rtdb.asia-southeast1.firebasedatabase.app");let l=r.orderId||"order-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,8));console.log("Generated order ID:",l);let c=new Date().toISOString(),u={orderId:l,userId:e,items:r.items||[],subtotal:r.subtotal||0,shippingCost:r.shippingCost||0,total:r.total||0,customerInfo:{name:(null==(t=r.customerInfo)?void 0:t.name)||"",email:(null==(o=r.customerInfo)?void 0:o.email)||"",phone:(null==(s=r.customerInfo)?void 0:s.phone)||"",address:(null==(n=r.customerInfo)?void 0:n.address)||""},status:"pending",paymentStatus:"unpaid",paymentMethod:r.paymentMethod||"COD",shippingMethod:r.shippingMethod||"standard",notes:r.notes||"",createdAt:c,updatedAt:c,orderDate:r.orderDate||c,statusHistory:[{status:"pending",timestamp:c,note:"Đơn h\xe0ng mới được tạo"}]};console.log("Order data to save:",u),console.log("Attempting to write to Realtime Database..."),console.log("User ID:",e),console.log("Authentication status:",(null==a?void 0:a.currentUser)?"Logged in":"Not logged in");let g=(0,d.KR)(i,"orders/".concat(l));console.log("Order ref path:","orders/".concat(l));let h=(0,d.KR)(i,"users/".concat(e,"/orders/").concat(l));console.log("User order ref path:","users/".concat(e,"/orders/").concat(l));try{console.log("Saving main order data..."),await (0,d.hZ)(g,u),console.log("Main order data saved successfully")}catch(e){throw console.error("Error saving main order data:",e),Error("Failed to save main order: ".concat(e.message))}try{console.log("Adding order ID to user profile..."),await (0,d.hZ)(h,{orderId:l,timestamp:u.createdAt}),console.log("Order ID added to user profile successfully")}catch(e){console.error("Error adding order ID to user profile:",e)}return console.log("Order saved successfully to RTDB"),l}catch(e){throw console.error("Create order error (RTDB):",e),console.error("Error details:",e.code,e.message),Error("Failed to save order: ".concat(e.message))}},F=async e=>{if(!i)throw console.error("Firebase Realtime Database is not initialized when getting user orders"),Error("Firebase Realtime Database is not initialized");try{console.log("Attempting to get order history for user:",e);let r=(0,d.KR)(i,"users/".concat(e,"/orders"));console.log("User orders ref created:",r);let t=await (0,d.Jt)(r);if(!t.exists())return console.log("No orders found for user"),[];let o=t.val();console.log("User order IDs retrieved:",o);let a=Object.entries(o).map(async e=>{let[r,t]=e;try{let e=(0,d.KR)(i,"orders/".concat(r)),t=await (0,d.Jt)(e);if(t.exists())return{...t.val(),id:r};return console.warn("Order ".concat(r," not found in orders collection")),null}catch(e){return console.error("Error fetching order ".concat(r,":"),e),null}});return(await Promise.all(a)).filter(e=>null!==e).sort((e,r)=>new Date(r.createdAt).getTime()-new Date(e.createdAt).getTime())}catch(e){throw console.error("Get user orders error (RTDB):",e),console.error("Error details:",e.code,e.message),Error("Failed to get user orders: ".concat(e.message))}},v=async()=>{if(!i)return console.error("Firebase Realtime Database is not initialized"),{success:!1,error:"Firebase Realtime Database is not initialized"};try{console.log("Testing Realtime Database connection...");let e=(0,d.KR)(i,"connection-test"),r=new Date().toISOString();await (0,d.hZ)(e,{timestamp:r,message:"Connection test successful"}),console.log("Successfully wrote to Realtime Database");let t=await (0,d.Jt)(e);if(t.exists())return console.log("Successfully read from Realtime Database:",t.val()),{success:!0,data:t.val()};return console.error("Test location does not exist after writing"),{success:!1,error:"Test location does not exist after writing"}}catch(e){return console.error("Realtime Database test failed:",e),{success:!1,error:e.message,code:e.code}}},I=async e=>{if(!i||!e)return"guest";try{let r=(0,d.KR)(i,"users/".concat(e)),t=await (0,d.Jt)(r);if(t.exists())return t.val().role||"user";return"guest"}catch(e){return console.error("Error getting user role:",e),"guest"}},A=async e=>{if(!i||!e)return!1;try{let r=(0,d.KR)(i,"admins/".concat(e)),t=await (0,d.Jt)(r);if(t.exists()){let e=t.val();return!0===e.isAdmin}let o=await I(e);return"admin"===o}catch(e){return console.error("Error checking admin status:",e),!1}},z=async e=>{if(!i||!e)return null;try{let r=(0,d.KR)(i,"users/".concat(e)),t=await (0,d.Jt)(r);if(t.exists())return t.val();return null}catch(e){return console.error("Error getting user data:",e),null}},L=async(e,r)=>{try{let t=await h(e,r,"admin");return console.log("Admin user created: ".concat(t.uid)),t}catch(e){return console.error("Error creating admin user:",e),null}}}}]);